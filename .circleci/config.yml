version: 2.1

orbs:
  # SonarCloud orb for automated code quality and security analysis (SAST)
  sonarcloud: sonarsource/sonarcloud@3.0.1

jobs:
  # Job 1: SAST (Static Application Security Testing) using SonarCloud Orb
  sast-scan:
    docker:
      - image: cimg/node:20.11
    steps:
      - checkout
      
      # Install dependencies
      - run:
          name: Install Dependencies
          command: |
            npm install --ignore-scripts
            npm install --prefix backend --ignore-scripts
      
      # Generate SSL certificates for backend tests
      - run:
          name: Generate SSL Certificates
          command: |
            mkdir -p certs
            cd certs
            if [ ! -f localhost.pem ]; then
              openssl req -x509 -newkey rsa:2048 -keyout localhost-key.pem -out localhost.pem -days 365 -nodes -subj "/CN=localhost" 2>/dev/null
            fi
      
      # Start backend server for coverage tests
      - run:
          name: Start Backend Server
          command: |
            cd backend
            node index.js > /tmp/backend.log 2>&1 &
            echo $! > /tmp/backend.pid
            sleep 3
          background: true
      
      # Run tests with coverage
      - run:
          name: Run Tests with Coverage
          command: |
            cd backend
            # Wait for server to be ready
            for i in {1..30}; do
              if curl -k -s https://localhost:4000 > /dev/null 2>&1; then
                echo "Server is ready"
                break
              fi
              sleep 1
            done
            # Run tests with coverage
            npm run test:coverage || echo "Coverage generation completed"
      
      # Stop backend server
      - run:
          name: Stop Backend Server
          command: |
            if [ -f /tmp/backend.pid ]; then
              kill $(cat /tmp/backend.pid) || true
            fi
          when: always
      
      # Run SonarCloud SAST scan
      - sonarcloud/scan
      
      # Wait for and enforce Quality Gate using sonar-scanner-cli
      - run:
          name: Wait for Quality Gate and Enforce
          command: |
            echo "Checking Quality Gate status..."
            
            # Read the task report to get the CE Task ID
            REPORT_FILE=".scannerwork/report-task.txt"
            
            if [ ! -f "$REPORT_FILE" ]; then
              echo "Error: Report file not found at $REPORT_FILE"
              exit 1
            fi
            
            # Extract the CE Task URL and server URL
            CE_TASK_URL=$(grep ceTaskUrl "$REPORT_FILE" | cut -d'=' -f2-)
            SERVER_URL=$(grep serverUrl "$REPORT_FILE" | cut -d'=' -f2-)
            
            echo "SonarCloud Server: $SERVER_URL"
            echo "CE Task URL: $CE_TASK_URL"
            
            # Wait for analysis to complete and check Quality Gate
            MAX_ATTEMPTS=60
            ATTEMPT=0
            
            while [ $ATTEMPT -lt $MAX_ATTEMPTS ]; do
              ATTEMPT=$((ATTEMPT + 1))
              echo "Attempt $ATTEMPT/$MAX_ATTEMPTS: Checking analysis status..."
              
              # Get the analysis status
              TASK_STATUS=$(curl -s -u "$SONAR_TOKEN:" "$CE_TASK_URL" | grep -o '"status":"[^"]*"' | cut -d'"' -f4)
              
              echo "Task status: $TASK_STATUS"
              
              if [ "$TASK_STATUS" = "SUCCESS" ]; then
                echo "✅ Analysis completed successfully"
                
                # Get the Quality Gate status
                ANALYSIS_ID=$(curl -s -u "$SONAR_TOKEN:" "$CE_TASK_URL" | grep -o '"analysisId":"[^"]*"' | cut -d'"' -f4)
                QG_STATUS=$(curl -s -u "$SONAR_TOKEN:" "${SERVER_URL}/api/qualitygates/project_status?analysisId=${ANALYSIS_ID}" | grep -o '"status":"[^"]*"' | head -1 | cut -d'"' -f4)
                
                echo "Quality Gate Status: $QG_STATUS"
                
                if [ "$QG_STATUS" = "OK" ]; then
                  echo "✅ Quality Gate PASSED!"
                  exit 0
                elif [ "$QG_STATUS" = "ERROR" ]; then
                  echo "❌ Quality Gate FAILED!"
                  echo "Please check SonarCloud dashboard for details: ${SERVER_URL}/dashboard?id=$(grep projectKey "$REPORT_FILE" | cut -d'=' -f2-)"
                  exit 1
                else
                  echo "⚠️  Quality Gate status: $QG_STATUS"
                  exit 1
                fi
              elif [ "$TASK_STATUS" = "FAILED" ] || [ "$TASK_STATUS" = "CANCELED" ]; then
                echo "❌ Analysis task failed with status: $TASK_STATUS"
                exit 1
              fi
              
              # Wait before next check
              sleep 5
            done
            
            echo "❌ Timeout waiting for analysis to complete"
            exit 1

  # Job 2: SCA (Software Composition Analysis) using npm audit
  sca-scan:
    docker:
      - image: cimg/node:20.11
    steps:
      - checkout
      
      # Cache dependencies
      - restore_cache:
          keys:
            - v1-dependencies-{{ checksum "package.json" }}-{{ checksum "backend/package.json" }}-{{ checksum "frontend/package.json" }}
            - v1-dependencies-
      
      # Install dependencies (ignore scripts to avoid patch-package errors)
      - run:
          name: Install Dependencies
          command: |
            npm install --ignore-scripts
            npm install --prefix backend --ignore-scripts
            npm install --prefix frontend --ignore-scripts
      
      - save_cache:
          paths:
            - node_modules
            - backend/node_modules
            - frontend/node_modules
          key: v1-dependencies-{{ checksum "package.json" }}-{{ checksum "backend/package.json" }}-{{ checksum "frontend/package.json" }}
      
      # Run npm audit on root workspace
      - run:
          name: Run npm audit on Root Workspace
          command: |
            echo "=== Running npm audit on root workspace ==="
            npm audit --audit-level=moderate || true
      
      # Run npm audit on backend
      - run:
          name: Run npm audit on Backend
          command: |
            echo "=== Running npm audit on backend ==="
            cd backend
            npm audit --audit-level=moderate || true
      
      # Run npm audit on frontend
      - run:
          name: Run npm audit on Frontend
          command: |
            echo "=== Running npm audit on frontend ==="
            cd frontend
            npm audit --audit-level=moderate || true
      
      # Generate comprehensive SCA report
      - run:
          name: Generate SCA Security Report
          command: |
            echo "=== Software Composition Analysis (SCA) Report ===" > sca-report.txt
            echo "Generated: $(date)" >> sca-report.txt
            echo "" >> sca-report.txt
            
            echo "--- Root Workspace ---" >> sca-report.txt
            npm audit --json >> sca-report.txt 2>&1 || true
            echo "" >> sca-report.txt
            
            echo "--- Backend Dependencies ---" >> sca-report.txt
            cd backend && npm audit --json >> ../sca-report.txt 2>&1 || true
            cd ..
            echo "" >> sca-report.txt
            
            echo "--- Frontend Dependencies ---" >> sca-report.txt
            cd frontend && npm audit --json >> ../sca-report.txt 2>&1 || true
            
            echo "SCA report generated successfully"
      
      # Store SCA report as artifact
      - store_artifacts:
          path: sca-report.txt
          destination: security-reports/sca-report.txt

  # Job 3: API Security Testing (Rate Limiting, Security Headers, etc.)
  api-security-test:
    docker:
      - image: cimg/node:20.11
    steps:
      - checkout
      
      # Cache dependencies
      - restore_cache:
          keys:
            - v1-dependencies-{{ checksum "package.json" }}-{{ checksum "backend/package.json" }}-{{ checksum "frontend/package.json" }}
            - v1-dependencies-
      
      # Install dependencies (ignore scripts to avoid patch-package errors)
      - run:
          name: Install Dependencies
          command: |
            npm install --ignore-scripts
            npm install --prefix backend --ignore-scripts
            npm install --prefix frontend --ignore-scripts
      
      - save_cache:
          paths:
            - node_modules
            - backend/node_modules
            - frontend/node_modules
          key: v1-dependencies-{{ checksum "package.json" }}-{{ checksum "backend/package.json" }}-{{ checksum "frontend/package.json" }}
      
      # Generate SSL certificates for HTTPS testing
      - run:
          name: Generate Self-Signed SSL Certificates
          command: |
            mkdir -p certs
            cd certs
            if [ ! -f localhost.pem ]; then
              echo "Generating self-signed SSL certificates..."
              openssl req -x509 -newkey rsa:2048 -keyout localhost-key.pem -out localhost.pem -days 365 -nodes -subj "/CN=localhost" 2>/dev/null
              echo "SSL certificates generated successfully"
            else
              echo "SSL certificates already exist"
            fi
      
      # Start backend API server
      - run:
          name: Start Backend API Server
          command: |
            cd backend
            node index.js > /tmp/backend-server.log 2>&1 &
            echo $! > /tmp/server.pid
            echo "Backend server started with PID: $(cat /tmp/server.pid)"
          background: true
      
      # Wait for API server to be ready
      - run:
          name: Wait for API Server to Start
          command: |
            echo "Waiting for API server to start..."
            for i in {1..30}; do
              if curl -k -s https://localhost:4000 > /dev/null 2>&1; then
                echo "✅ API server is ready!"
                break
              fi
              echo "⏳ Waiting for server... (attempt $i/30)"
              sleep 2
            done
            
            # Verify server is responding
            if ! curl -k -s https://localhost:4000 > /dev/null 2>&1; then
              echo "❌ ERROR: API server failed to start"
              echo "=== Backend Server Logs ==="
              cat /tmp/backend-server.log
              exit 1
            fi
      
      # Run API security tests
      - run:
          name: Run API Security Tests (Rate Limiting & Security Headers)
          command: |
            cd backend
            echo "Running API security tests..."
            npm run security-tests
            TEST_RESULT=$?
            
            if [ $TEST_RESULT -ne 0 ]; then
              echo "❌ Security tests failed"
              echo "=== Backend Server Logs ==="
              cat /tmp/backend-server.log
            else
              echo "✅ All security tests passed"
            fi
            
            exit $TEST_RESULT
      
      # Stop API server
      - run:
          name: Stop Backend API Server
          command: |
            if [ -f /tmp/server.pid ]; then
              SERVER_PID=$(cat /tmp/server.pid)
              echo "Stopping server with PID: $SERVER_PID"
              kill $SERVER_PID || true
              sleep 2
            fi
          when: always
      
      # Store test results and logs
      - store_artifacts:
          path: /tmp/backend-server.log
          destination: security-reports/backend-server.log

workflows:
  version: 2
  security-testing-pipeline:
    jobs:
      # Run SAST scan first
      - sast-scan:
          context: SonarCloud
      
      # Run SCA scan in parallel with SAST or after
      - sca-scan:
          requires:
            - sast-scan
      
      # Run API security tests after SCA
      - api-security-test:
          requires:
            - sca-scan
