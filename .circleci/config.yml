version: 2.1

orbs:
  # SonarCloud orb for automated code quality and security analysis
  sonarcloud: sonarsource/sonarcloud@3.0.1

jobs:
  build-and-scan:
    docker:
      - image: cimg/openjdk:17.0-node
    steps:
      - checkout
      
      # 1. Install Dependencies
      - run:
          name: Install Dependencies
          command: |
            npm install
            cd backend && npm install
            cd ../frontend && npm install
      
      # 1.5. Add Dependency Security Check (SCA)
      - run:
          name: Dependency Vulnerability Check (SCA)
          command: npm audit --audit-level=critical || true
      
      # 2. Run Unit Tests and Generate Coverage Report
      - run:
          name: Run Unit Tests and Generate Coverage Report
          command: npm test -- --coverage --watchAll=false
      
      # 3. Run API Security Tests (Rate Limiting & Headers)
      - run:
          name: Start Backend Server and Run Security Tests
          command: |
            # Generate self-signed certificates for testing
            mkdir -p certs
            cd certs
            if [ ! -f localhost.pem ]; then
              openssl req -x509 -newkey rsa:2048 -keyout localhost-key.pem -out localhost.pem -days 365 -nodes -subj "/CN=localhost" 2>/dev/null
            fi
            cd ../backend
            # Start server in background
            npm run dev > /tmp/backend-server.log 2>&1 &
            SERVER_PID=$!
            echo "Server started with PID: $SERVER_PID"
            # Wait for server to be ready (check if port is listening)
            for i in {1..30}; do
              if nc -z localhost 4000 2>/dev/null; then
                echo "Server is ready!"
                break
              fi
              echo "Waiting for server... ($i/30)"
              sleep 1
            done
            # Run security tests
            npm run security-tests
            TEST_RESULT=$?
            # Stop server
            kill $SERVER_PID || true
            # Show server logs if tests failed
            if [ $TEST_RESULT -ne 0 ]; then
              echo "=== Backend Server Logs ==="
              cat /tmp/backend-server.log
            fi
            # Exit with test result
            exit $TEST_RESULT
      
      # 4. Run the SonarCloud Scan
      - sonarcloud/scan

workflows:
  main:
    jobs:
      - build-and-scan:
          context: SonarCloud
